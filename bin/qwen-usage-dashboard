#!/usr/bin/env python3
"""
qwen-usage-dashboard ‚Äî Generate HTML Cost Dashboard for Qwen Models

Generates a comprehensive HTML report with charts showing:
- Daily usage trends
- Model distribution
- Cost projections
- Budget status

USAGE:
    qwen-usage-dashboard [OPTIONS]

OPTIONS:
    --period PERIOD   Time period (today, week, month, all) [default: week]
    --output PATH     Output file path [default: /opt/ai-orchestrator/var/reports/cost-dashboard-{date}.html]
    --open            Open in browser after generation
    --quiet           Suppress output messages
    --help            Show this help

EXAMPLES:
    qwen-usage-dashboard                           # Generate weekly report
    qwen-usage-dashboard --period month            # Monthly report
    qwen-usage-dashboard --output /tmp/report.html # Custom output
"""

import sys
import os
from pathlib import Path
from datetime import datetime, timezone
import json

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from lib.dashscope_monitor import DashScopeMonitor, TEST_BUDGET_TOKENS, WELCOME_CREDIT_TOKENS

def generate_html_dashboard(monitor, period='week', output_path=None):
    """Generate HTML dashboard with Chart.js visualizations."""
    
    # Gather data
    usage = monitor.get_usage(period)
    budget = monitor.get_remaining_credit()
    projection = monitor.project_monthly()
    
    now = datetime.now(timezone.utc)
    report_date = now.strftime('%Y-%m-%d %H:%M UTC')
    
    # Prepare chart data
    daily_labels = [d['date'][5:] for d in sorted(usage.daily_breakdown, key=lambda x: x['date'])]  # MM-DD
    daily_tokens = [d['tokens'] for d in sorted(usage.daily_breakdown, key=lambda x: x['date'])]
    daily_costs = [d['cost_usd'] for d in sorted(usage.daily_breakdown, key=lambda x: x['date'])]
    
    model_labels = list(usage.by_model.keys())
    model_tokens = [usage.by_model[m]['total_tokens'] for m in model_labels]
    model_costs = [usage.by_model[m]['cost_usd'] for m in model_labels]
    
    # Budget bar calculation
    budget_pct = budget.test_budget_pct
    welcome_pct = (budget.welcome_credit_used / budget.welcome_credit_total) * 100 if budget.welcome_credit_total > 0 else 0
    
    # Alert colors
    alert_color = '#28a745' if budget.alert_level == 'ok' else ('#ffc107' if budget.alert_level == 'warn' else '#dc3545')
    
    html = f'''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen Models - Cost Dashboard ({report_date})</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }}
        .container {{ max-width: 1400px; margin: 0 auto; }}
        .header {{
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        .header h1 {{ color: #333; margin-bottom: 10px; }}
        .header p {{ color: #666; }}
        .grid {{ 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            margin-bottom: 20px;
        }}
        .card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        .card h2 {{ 
            color: #333; 
            margin-bottom: 20px; 
            font-size: 1.3em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }}
        .stat-grid {{ 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
        }}
        .stat {{
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }}
        .stat-value {{ 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #667eea;
        }}
        .stat-label {{ 
            font-size: 0.9em; 
            color: #666; 
            margin-top: 5px;
        }}
        .chart-container {{ 
            position: relative; 
            height: 300px; 
            margin-top: 20px;
        }}
        .budget-bar {{
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 15px 0;
        }}
        .budget-fill {{
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }}
        .alert {{
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
        }}
        .alert-ok {{ background: #d4edda; color: #155724; }}
        .alert-warn {{ background: #fff3cd; color: #856404; }}
        .alert-critical {{ background: #f8d7da; color: #721c24; }}
        table {{ 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
        }}
        th, td {{ 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef;
        }}
        th {{ background: #f8f9fa; font-weight: 600; color: #333; }}
        tr:hover {{ background: #f8f9fa; }}
        .model-name {{ font-family: monospace; color: #667eea; }}
        .wide-card {{ grid-column: 1 / -1; }}
        @media (max-width: 768px) {{
            .stat-grid {{ grid-template-columns: 1fr; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Qwen Models Cost Dashboard</h1>
            <p>DashScope-Intl Usage Report | Generated: {report_date} | Period: {usage.period}</p>
        </div>
        
        <!-- Summary Stats -->
        <div class="grid">
            <div class="card">
                <h2>üìä Token Usage</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="stat-value">{usage.total_tokens:,}</div>
                        <div class="stat-label">Total Tokens</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{usage.input_tokens:,}</div>
                        <div class="stat-label">Input Tokens</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{usage.output_tokens:,}</div>
                        <div class="stat-label">Output Tokens</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{usage.calls_count:,}</div>
                        <div class="stat-label">API Calls</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üí∞ Costs</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="stat-value">${usage.total_cost_usd:.6f}</div>
                        <div class="stat-label">Total Cost</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${projection['daily_average_cost_usd']:.6f}</div>
                        <div class="stat-label">Daily Average</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${projection['projected_monthly_cost_usd']:.2f}</div>
                        <div class="stat-label">Projected Monthly</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${projection['daily_average_cost_usd']*365:.2f}</div>
                        <div class="stat-label">Projected Yearly</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Budget Status -->
        <div class="grid">
            <div class="card wide-card">
                <h2>üéØ Budget Status</h2>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 10px; color: #333;">Test Budget (1M tokens)</h3>
                    <div class="budget-bar">
                        <div class="budget-fill" style="width: {min(budget_pct, 100)}%; background: {alert_color};">
                            {budget_pct:.1f}%
                        </div>
                    </div>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value">{budget.test_budget_used:,}</div>
                            <div class="stat-label">Used</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">{budget.test_budget_remaining:,}</div>
                            <div class="stat-label">Remaining</div>
                        </div>
                    </div>
                    <div class="alert alert-{budget.alert_level}">
                        {'‚úÖ Budget status: OK' if budget.alert_level == 'ok' else 
                         '‚ö†Ô∏è WARNING: Approaching test budget limit!' if budget.alert_level == 'warn' else
                         'üõë CRITICAL: Test budget nearly exhausted!'}
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 10px; color: #333;">Welcome Credit (70M tokens)</h3>
                    <div class="budget-bar">
                        <div class="budget-fill" style="width: {min(welcome_pct, 100)}%; background: #28a745;">
                            {welcome_pct:.2f}%
                        </div>
                    </div>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value">{budget.welcome_credit_used:,}</div>
                            <div class="stat-label">Used</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">{budget.welcome_credit_remaining:,}</div>
                            <div class="stat-label">Remaining</div>
                        </div>
                    </div>
                    {f'<div class="alert alert-ok" style="margin-top: 15px;">‚úÖ At current rate: {budget.projected_exhaustion_days} days until exhaustion</div>' if budget.projected_exhaustion_days else ''}
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="grid">
            <div class="card wide-card">
                <h2>üìà Daily Trend</h2>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üî∑ Tokens by Model</h2>
                <div class="chart-container">
                    <canvas id="modelTokensChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üíµ Cost by Model</h2>
                <div class="chart-container">
                    <canvas id="modelCostChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Detailed Table -->
        <div class="card wide-card">
            <h2>üìã Detailed Breakdown by Model</h2>
            <table>
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Input Tokens</th>
                        <th>Output Tokens</th>
                        <th>Total Tokens</th>
                        <th>Cost (USD)</th>
                        <th>Calls</th>
                        <th>% of Total</th>
                    </tr>
                </thead>
                <tbody>
'''
    
    # Add model rows
    total_cost = usage.total_cost_usd if usage.total_cost_usd > 0 else 1
    sorted_models = sorted(usage.by_model.items(), key=lambda x: x[1]['cost_usd'], reverse=True)
    for model, stats in sorted_models:
        pct = (stats['cost_usd'] / total_cost) * 100
        html += f'''
                    <tr>
                        <td class="model-name">{model}</td>
                        <td>{stats['input_tokens']:,}</td>
                        <td>{stats['output_tokens']:,}</td>
                        <td>{stats['total_tokens']:,}</td>
                        <td>${stats['cost_usd']:.6f}</td>
                        <td>{stats['calls']:,}</td>
                        <td>{pct:.1f}%</td>
                    </tr>
'''
    
    html += '''
                </tbody>
            </table>
        </div>
        
        <!-- Projections -->
        <div class="grid">
            <div class="card wide-card">
                <h2>üîÆ Projections</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="stat-value" style="color: #28a745;">{projection['days_until_test_budget_exhausted'] or '‚àû'}</div>
                        <div class="stat-label">Days until test budget exhausted</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" style="color: #17a2b8;">{projection['days_until_welcome_credit_exhausted'] or '‚àû'}</div>
                        <div class="stat-label">Days until welcome credit exhausted</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" style="color: #6f42c1;">{projection['projected_monthly_tokens']:,}</div>
                        <div class="stat-label">Projected monthly tokens</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" style="color: #fd7e14;">${projection['projected_monthly_cost_usd']:.2f}</div>
                        <div class="stat-label">Projected monthly cost</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header" style="margin-top: 20px; text-align: center;">
            <p style="font-size: 0.9em; color: #999;">
                Generated by qwen-usage-dashboard | Data source: /opt/ai-orchestrator/var/logs/qwen-usage.tsv
            </p>
        </div>
    </div>
    
    <script>
        // Daily trend chart
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {{
            type: 'line',
            data: {{
                labels: {json.dumps(daily_labels)},
                datasets: [{{
                    label: 'Tokens',
                    data: {json.dumps(daily_tokens)},
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y',
                }}, {{
                    label: 'Cost (USD)',
                    data: {json.dumps(daily_costs)},
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1',
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                interaction: {{
                    mode: 'index',
                    intersect: false,
                }},
                scales: {{
                    y: {{
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {{ display: true, text: 'Tokens' }}
                    }},
                    y1: {{
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {{ drawOnChartArea: false }},
                        title: {{ display: true, text: 'Cost (USD)' }}
                    }}
                }}
            }}
        }});
        
        // Model tokens chart
        const modelTokensCtx = document.getElementById('modelTokensChart').getContext('2d');
        new Chart(modelTokensCtx, {{
            type: 'doughnut',
            data: {{
                labels: {json.dumps(model_labels)},
                datasets: [{{
                    data: {json.dumps(model_tokens)},
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c', 
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                        '#fa709a', '#fee140', '#30cfd0', '#330867'
                    ]
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        position: 'right',
                        labels: {{
                            boxWidth: 12,
                            font: {{ size: 10 }}
                        }}
                    }}
                }}
            }}
        }});
        
        // Model cost chart
        const modelCostCtx = document.getElementById('modelCostChart').getContext('2d');
        new Chart(modelCostCtx, {{
            type: 'bar',
            data: {{
                labels: {json.dumps(model_labels)},
                datasets: [{{
                    label: 'Cost (USD)',
                    data: {json.dumps(model_costs)},
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                scales: {{
                    y: {{
                        beginAtZero: true,
                        ticks: {{
                            callback: function(value) {{ return '$' + value.toFixed(4); }}
                        }}
                    }},
                    x: {{
                        ticks: {{
                            maxRotation: 45,
                            minRotation: 45
                        }}
                    }}
                }},
                plugins: {{
                    tooltip: {{
                        callbacks: {{
                            label: function(context) {{
                                return '$' + context.parsed.y.toFixed(6);
                            }}
                        }}
                    }}
                }}
            }}
        }});
    </script>
</body>
</html>
'''
    
    # Write to file
    if output_path:
        output_path = Path(output_path)
        output_path.parent.mkdir(parents=True, exist_ok=True)
        with open(output_path, 'w') as f:
            f.write(html)
        return str(output_path)
    
    return html


def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='Generate HTML Cost Dashboard for Qwen Models',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument('--period', default='week',
                       choices=['today', 'yesterday', 'week', 'month', 'all'],
                       help='Time period for report [default: week]')
    parser.add_argument('--output', metavar='PATH',
                       help='Output file path [default: /opt/ai-orchestrator/var/reports/cost-dashboard-{date}.html]')
    parser.add_argument('--open', action='store_true',
                       help='Open in browser after generation')
    parser.add_argument('-q', '--quiet', action='store_true',
                       help='Suppress output messages')
    
    args = parser.parse_args()
    
    # Initialize monitor
    try:
        monitor = DashScopeMonitor()
    except Exception as e:
        print(f"Error initializing monitor: {e}", file=sys.stderr)
        sys.exit(1)
    
    # Check if log file exists
    if not monitor.log_file.exists():
        print(f"No usage data found. Log file: {monitor.log_file}", file=sys.stderr)
        sys.exit(1)
    
    # Determine output path
    if args.output:
        output_path = Path(args.output)
    else:
        date_str = datetime.now(timezone.utc).strftime('%Y%m%d')
        output_dir = Path('/opt/ai-orchestrator/var/reports')
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f'cost-dashboard-{date_str}.html'
    
    # Generate dashboard
    try:
        result_path = generate_html_dashboard(monitor, args.period, output_path)
        
        if not args.quiet:
            print(f"‚úÖ Dashboard generated: {result_path}")
            print(f"   Period: {args.period}")
            print(f"   File size: {Path(result_path).stat().st_size:,} bytes")
        
        # Open in browser if requested
        if args.open:
            import subprocess
            try:
                subprocess.run(['xdg-open', result_path], check=True)
            except:
                try:
                    subprocess.run(['open', result_path], check=True)  # macOS
                except:
                    print(f"Could not open browser. Please open: {result_path}", file=sys.stderr)
        
    except Exception as e:
        print(f"Error generating dashboard: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc()
        sys.exit(1)
    
    sys.exit(0)


if __name__ == '__main__':
    main()
