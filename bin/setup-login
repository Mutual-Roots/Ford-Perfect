#!/usr/bin/env python3
"""
Einmaliger GUI-Login für alle Services.
Öffnet Chromium mit dem Orchestrator-Profil im KDE-Desktop von agency1.
Nach dem Login läuft alles headless weiter.
"""
import sys, os, subprocess, time
sys.path.insert(0, "/opt/ai-orchestrator")

SERVICES = {
    "claude":  "https://claude.ai",
    "gemini":  "https://aistudio.google.com",
    "copilot": "https://copilot.microsoft.com",
    "openai":  "https://chat.openai.com",
}

PROFILE_DIR = "/opt/ai-orchestrator/var/chromium-profile"
ENV = {
    **os.environ,
    "WAYLAND_DISPLAY": "wayland-0",
    "XDG_RUNTIME_DIR": "/run/user/1000",
    "DISPLAY": ":1",
}

def open_for_login(service: str, url: str):
    print(f"\n{'═'*50}")
    print(f"  Service: {service.upper()}")
    print(f"  URL:     {url}")
    print(f"{'═'*50}")
    print("  → Browser öffnet sich auf dem Desktop")
    print("  → Einloggen, dann hier Enter drücken")
    print()

    proc = subprocess.Popen(
        ["sudo", "-u", "agency1",
         "chromium",
         f"--user-data-dir={PROFILE_DIR}",
         "--password-store=basic",
         "--no-sandbox",
         url],
        env=ENV,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    input("  [Enter wenn eingeloggt] ")
    # Browser offen lassen — Profil wird beim Beenden gespeichert
    return proc

if __name__ == "__main__":
    services = sys.argv[1:] if sys.argv[1:] else list(SERVICES.keys())

    print("AI Orchestrator — Login Setup")
    print(f"Profil: {PROFILE_DIR}")
    print(f"Services: {', '.join(services)}")

    procs = []
    for svc in services:
        if svc not in SERVICES:
            print(f"Unbekannt: {svc}")
            continue
        p = open_for_login(svc, SERVICES[svc])
        procs.append(p)

    print("\nAlle Services abgehakt? Browser wird geschlossen...")
    time.sleep(2)
    for p in procs:
        try: p.terminate()
        except: pass

    print("✓ Login-Setup abgeschlossen. Orchestrator kann headless starten.")
    print(f"\nTest: python3 /opt/ai-orchestrator/bin/orchestrator")
