#!/usr/bin/env python3
"""
tokenmeter ‚Äî Unified Token Usage Dashboard for All AI Providers

Consolidates token usage and costs from:
- DashScope-Intl (Qwen models)
- Anthropic (Claude)
- OpenRouter (various models)
- Other providers configured in etc/providers.yaml

USAGE:
    tokenmeter [OPTIONS]

OPTIONS:
    --today         Show today's usage across all providers (default)
    --week          Show current week's usage
    --month         Show current month's usage
    --all           Show all-time usage
    --provider NAME Filter by provider (qwen, anthropic, openrouter, etc.)
    --json          Output as JSON
    --csv           Output as CSV
    --dashboard     Generate HTML dashboard
    --quiet, -q     Minimal output
    --help, -h      Show help

EXAMPLES:
    tokenmeter                          # Today's summary all providers
    tokenmeter --week --json            # Week usage as JSON
    tokenmeter --provider qwen          # Qwen only
    tokenmeter --dashboard              # Generate HTML report
"""

import sys
import os
from pathlib import Path
from datetime import datetime, timezone
import json

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from lib.dashscope_monitor import DashScopeMonitor

def load_provider_config():
    """Load provider configuration from YAML."""
    import yaml
    
    config_path = Path('/opt/ai-orchestrator/etc/providers.yaml')
    if not config_path.exists():
        return {}
    
    try:
        with open(config_path) as f:
            return yaml.safe_load(f)
    except:
        return {}

def get_qwen_stats(period='today'):
    """Get Qwen/DashScope stats."""
    try:
        monitor = DashScopeMonitor()
        if not monitor.log_file.exists():
            return None
        
        usage = monitor.get_usage(period)
        budget = monitor.get_remaining_credit()
        
        return {
            'provider': 'qwen',
            'display_name': 'Alibaba Qwen (DashScope-Intl)',
            'total_tokens': usage.total_tokens,
            'input_tokens': usage.input_tokens,
            'output_tokens': usage.output_tokens,
            'cost_usd': usage.total_cost_usd,
            'calls': usage.calls_count,
            'by_model': usage.by_model,
            'budget_status': {
                'test_budget_used': budget.test_budget_used,
                'test_budget_remaining': budget.test_budget_remaining,
                'test_budget_pct': budget.test_budget_pct,
                'alert_level': budget.alert_level,
            }
        }
    except Exception as e:
        return None

def get_anthropic_stats(period='today'):
    """Get Anthropic stats from logs or API."""
    # TODO: Implement when Anthropic integration exists
    return None

def get_openrouter_stats(period='today'):
    """Get OpenRouter stats from logs or API."""
    # TODO: Implement when OpenRouter integration exists
    return None

def format_number(n):
    """Format number with commas."""
    return f"{n:,}"

def print_dashboard(all_stats, period, quiet=False):
    """Print unified dashboard."""
    if quiet:
        total_tokens = sum(s['total_tokens'] for s in all_stats.values() if s)
        total_cost = sum(s['cost_usd'] for s in all_stats.values() if s)
        total_calls = sum(s['calls'] for s in all_stats.values() if s)
        print(f"{total_tokens}\t{total_cost:.6f}\t{total_calls}")
        return
    
    print("=" * 80)
    print("üéØ UNIFIED TOKEN METER - All AI Providers")
    print("=" * 80)
    print(f"Period: {period} | Generated: {datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M UTC')}")
    print("-" * 80)
    
    # Summary totals
    total_tokens = 0
    total_cost = 0
    total_calls = 0
    
    print("\nüìä PROVIDER SUMMARY")
    print("-" * 80)
    print(f"{'Provider':<35} {'Tokens':>15} {'Cost (USD)':>15} {'Calls':>10}")
    print("-" * 80)
    
    for provider_key, stats in all_stats.items():
        if not stats:
            continue
        
        total_tokens += stats['total_tokens']
        total_cost += stats['cost_usd']
        total_calls += stats['calls']
        
        icon = "‚úÖ" if stats.get('budget_status', {}).get('alert_level') == 'ok' else "‚ö†Ô∏è"
        print(f"{icon} {stats['display_name']:<32} {format_number(stats['total_tokens']):>15} ${stats['cost_usd']:>13.6f} {stats['calls']:>10}")
    
    print("-" * 80)
    print(f"{'TOTAL':<35} {format_number(total_tokens):>15} ${total_cost:>13.6f} {total_calls:>10}")
    
    # Detailed breakdowns
    for provider_key, stats in all_stats.items():
        if not stats or not stats.get('by_model'):
            continue
        
        print(f"\nüîπ {stats['display_name']} - Model Breakdown")
        print("-" * 80)
        print(f"{'Model':<40} {'Tokens':>12} {'Cost (USD)':>14} {'Calls':>8}")
        print("-" * 80)
        
        sorted_models = sorted(stats['by_model'].items(), key=lambda x: x[1]['cost_usd'], reverse=True)
        for model, model_stats in sorted_models[:10]:  # Top 10
            print(f"{model:<40} {format_number(model_stats['total_tokens']):>12} ${model_stats['cost_usd']:>12.6f} {model_stats['calls']:>8}")
    
    # Budget alerts
    print("\n‚ö†Ô∏è  BUDGET ALERTS")
    print("-" * 80)
    
    has_alerts = False
    for provider_key, stats in all_stats.items():
        if not stats or not stats.get('budget_status'):
            continue
        
        bs = stats['budget_status']
        if bs['alert_level'] != 'ok':
            has_alerts = True
            icon = "üõë" if bs['alert_level'] == 'critical' else "‚ö†Ô∏è"
            print(f"{icon} {stats['display_name']}: {bs['test_budget_pct']:.1f}% of test budget used")
            print(f"   Remaining: {format_number(bs['test_budget_remaining'])} tokens")
    
    if not has_alerts:
        print("‚úÖ All providers within budget limits")
    
    print("\n" + "=" * 80)

def show_help():
    """Show help message."""
    print(__doc__)

def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='Unified Token Usage Dashboard for All AI Providers',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        add_help=False
    )
    
    # Period options
    period_group = parser.add_mutually_exclusive_group()
    period_group.add_argument('--today', action='store_true', help="Today's usage (default)")
    period_group.add_argument('--week', action='store_true', help="Current week")
    period_group.add_argument('--month', action='store_true', help="Current month")
    period_group.add_argument('--all', action='store_true', help="All-time")
    
    # Other options
    parser.add_argument('--provider', metavar='NAME', help='Filter by provider')
    parser.add_argument('--json', action='store_true', help='Output as JSON')
    parser.add_argument('--csv', action='store_true', help='Output as CSV')
    parser.add_argument('--dashboard', action='store_true', help='Generate HTML dashboard')
    parser.add_argument('-q', '--quiet', action='store_true', help='Minimal output')
    parser.add_argument('-h', '--help', action='store_true', help='Show help')
    
    args = parser.parse_args()
    
    if args.help:
        show_help()
        sys.exit(0)
    
    # Determine period
    if args.week:
        period = 'week'
    elif args.month:
        period = 'month'
    elif args.all:
        period = 'all'
    else:
        period = 'today'
    
    # Collect stats from all providers
    all_stats = {}
    
    # Qwen/DashScope
    if not args.provider or args.provider.lower() == 'qwen':
        qwen_stats = get_qwen_stats(period)
        if qwen_stats:
            all_stats['qwen'] = qwen_stats
    
    # Anthropic (placeholder)
    if not args.provider or args.provider.lower() == 'anthropic':
        anthropic_stats = get_anthropic_stats(period)
        if anthropic_stats:
            all_stats['anthropic'] = anthropic_stats
    
    # OpenRouter (placeholder)
    if not args.provider or args.provider.lower() == 'openrouter':
        openrouter_stats = get_openrouter_stats(period)
        if openrouter_stats:
            all_stats['openrouter'] = openrouter_stats
    
    # Check if we have any data
    if not all_stats:
        if not args.quiet:
            print("No usage data found from any provider.", file=sys.stderr)
        sys.exit(0)
    
    # Output
    if args.json:
        output = {
            'period': period,
            'generated_at': datetime.now(timezone.utc).isoformat(),
            'providers': all_stats,
        }
        print(json.dumps(output, indent=2))
    elif args.csv:
        # Simple CSV output
        print("Provider,Total Tokens,Input Tokens,Output Tokens,Cost USD,Calls")
        for provider_key, stats in all_stats.items():
            if stats:
                print(f"{provider_key},{stats['total_tokens']},{stats['input_tokens']},{stats['output_tokens']},{stats['cost_usd']:.6f},{stats['calls']}")
    elif args.dashboard:
        # Generate HTML dashboard
        from bin.qwen_usage_dashboard import generate_html_dashboard
        # For now, just use Qwen dashboard
        monitor = DashScopeMonitor()
        output_path = Path(f'/opt/ai-orchestrator/var/reports/tokenmeter-dashboard-{datetime.now(timezone.utc).strftime("%Y%m%d")}.html')
        result = generate_html_dashboard(monitor, period, output_path)
        print(f"Dashboard generated: {result}")
    else:
        print_dashboard(all_stats, period, args.quiet)
    
    sys.exit(0)


if __name__ == '__main__':
    main()
